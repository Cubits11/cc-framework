# Week 3 Memo — FH Ceilings & Finite-Sample CC
**Author:** Pranav Bhave  
**Date:** 2025-09-12

## 1) Goals
- Implement Fréchet–Hoeffding (FH) **ceilings** for composed Youden’s J (AND/OR) over two ROC curves.
- Add **finite-sample CC** (composability coefficient) confidence intervals at a fixed operating point θ using FH–Bernstein.
- Ship an **auditor** and **tamper‑evident** JSONL logging.

## 2) Methods (Week‑3 additions)
- **FH envelope on ROC×ROC.**
  - AND: \(J_{\wedge} = \min(\mathrm{TPR}_a,\mathrm{TPR}_b) - \max(0,\mathrm{FPR}_a+\mathrm{FPR}_b-1)\)
  - OR:  \(J_{\vee} = \min(1,\mathrm{TPR}_a+\mathrm{TPR}_b) - \max(\mathrm{FPR}_a,\mathrm{FPR}_b)\)
- **Fixed‑θ FH intervals.** With θ=(τ_a,τ_b), empirical marginals (TPR/FPR) and an FPR policy cap α:
  - \(I_1=[\max(0,\mathrm{TPR}_a+\mathrm{TPR}_b-1),\min(\mathrm{TPR}_a,\mathrm{TPR}_b)]\) for \(p_1=P(A\wedge B=1\mid Y=1)\).
  - \(I_0=[\max(\mathrm{FPR}_a,\mathrm{FPR}_b),\min(1,\mathrm{FPR}_a+\mathrm{FPR}_b,\alpha)]\) for \(p_0=P(A\vee B=1\mid Y=0)\).
- **Bernstein CI for CC.** With variance envelope \(\bar v = \max_{p\in I} p(1-p)\), invert two‑sided Bernstein tails and propagate through
  \(\mathrm{CC} = (1 - (p_1 - p_0))/D\).
- **Classical baselines.** Wilson & Newcombe intervals for \(\Delta=p_1-p_0\), mapped to CC.

## 3) Inputs at θ (Week‑3 methods run)
- Empirical: \(p_1\_\hat=0.62\), \(p_0\_\hat=0.09\); \(n_1=n_0=200\)
- Denominator: \(D=0.55\)
- Operating rates: TPR_a=0.72, TPR_b=0.65, FPR_a=0.035, FPR_b=0.05
- Policy: α‑cap=0.05

## 4) FH intervals & variance envelopes
- \(I_1=[0.370, 0.650]\) → \(\bar v_1=0.250\)
- \(I_0=[0.050, 0.050]\) → \(\bar v_0=0.0475\)

*Note:* With α‑cap binding, \(I_0\) collapses to a point at 0.05.

## 5) Point & confidence intervals for CC
- \(\widehat{\mathrm{CC}} = 0.854545\)
- **Bernstein (δ=0.05)**: [0.553215, 1.155876]  
  width = 0.602660 (±0.301330)
- **Wilson/Newcombe (≈95%)**: [0.678686, 1.066725]  
  width = 0.388038 (±0.194019)

**Observed half‑width t** (Bernstein) = 0.301330.  
Bernstein union‑bound at this t: **2.472e-04** (≪ δ).

### Smoke run (δ=0.10)
- Bernstein: [0.580302, 1.128789] (width 0.548486, ±0.274243)  
- Wilson:    [0.704477, 1.030338] (width 0.325861, ±0.162931)

## 6) Sample‑size planner (target half‑width t=0.10 at δ=0.05)
- \(n_1^* = 777.4\)
- \(n_0^* = 190.7\)

## 7) Figures
- **Fig 1 — FH envelope heatmap:** `figs/fig_week3_fh_heatmap.png`  
  Shows J‑ceiling over ROC×ROC and argmax location.
- **Fig 2 — CC CIs at θ:** `figs/fig_week3_cc_cis.png`  
  Compares FH–Bernstein vs. Newcombe intervals around CĈ.

(If missing, generate with `python scripts/make_week3_figs.py --p1-hat 0.62 --p0-hat 0.09 --n1 200 --n0 200 --D 0.55 --tpr-a 0.72 --tpr-b 0.65 --fpr-a 0.035 --fpr-b 0.05 --alpha-cap 0.05`.)

## 8) Validation & audit
- **FH ceiling auditor:** no violations on evaluated pairs.  
- **Tamper‑evident log:** appended to `runs/audit.jsonl`; chain verified OK.

## 9) Limitations & next steps
- Bernstein bound is conservative; investigate tighter variance envelopes or adaptive splits of δ.
- Extend beyond two‑rail composition and across θ‑grids; integrate into `cartographer/atlas.py` flow.

## 10) Repro
```bash
pip install -e .
python scripts/make_week3_figs.py --p1-hat 0.62 --p0-hat 0.09   --n1 200 --n0 200 --D 0.55   --tpr-a 0.72 --tpr-b 0.65 --fpr-a 0.035 --fpr-b 0.05   --alpha-cap 0.05
pytest -q tests/unit/test_week3_ci_and_audit.py
```
